<!DOCTYPE html>
<html>
	<head>
		<title>Game page</title>
		{% load staticfiles %} 
        <link rel="stylesheet" type="text/css" href="{% static 'gamestore/home.css'%}" />
		<meta charset="utf-8">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
		<script>
			/* global $ */
			$(document).ready(function() {
				'use strict';
				$(window).on('message', function(evt) {
					//Note that messages from all origins are accepted

					//Get data from sent message
					var data = evt.originalEvent.data;

					//if SCORE, display score on parent HTML
					if (data.messageType == "SCORE"){
						$('#scores').html(data.score);
					}
					
					else if (data.messageType == "SAVE"){
						//HARDCODED GAME ID
						var gameid = 32;
						//REPLACE WITH CODE TO GET IDS DYNAMICALLY

						var playerid = document.getElementById("playerid").value;

                                		var csrftoken = getCookie('csrftoken');
                                		$.ajax({
                                        		type : "POST",
                                        		url : "/savegamestate/",
                                        		data : {'gameid': gameid, 'playerid': playerid, 'jsondata' : JSON.stringify(data), 'csrfmiddlewaretoken': csrftoken},
							dataType : "json",
                                        		success : function(data){
								var gamedata = '<p>';
                                                                gamedata += "Player items: " + data['playerItems'] + '</p>';
                                                                gamedata += '<p>' + "Score: " + data['score'] + '</p><br>';
                                                                $('#gamestate').html(gamedata);
								alert("Game saved successfully!");
                                        		}
                                		});
					}
					else if (data.messageType == "LOAD_REQUEST"){
						var csrftoken = getCookie('csrftoken');
						var gameid = 32;
						var playerid = document.getElementById("playerid").value;
						$.ajax({
							type : "POST",
							url : "/loadgamestate/",
							data : {'gameid': gameid, 'playerid': playerid, 'jsondata' : JSON.stringify(data), 'csrfmiddlewaretoken' : csrftoken},
							dataType : "json",
							success : function(data){
								// Gamestate exists, messageType = LOAD
								if (data['messageType'] == "LOAD"){
									var gamedata = '<p>';
									var state = $.parseJSON(data["gameState"]);
									gamedata += "Player items: " + state.playerItems + '</p>';
									gamedata += '<p>' + "Score: " + state.score + '</p><br>';
									$('#gamestate').html(gamedata);
								}
								// No gamestate found, messageType = MESSAGE
								else {
									$('#gamestate').html(data['message']);
								}
							}
						});
					}
				});
  			});

			function getCookie(name) {
                        	var cookieValue = null;
                        	if (document.cookie && document.cookie != '') {
                                	var cookies = document.cookie.split(';');
                                	for (var i = 0; i < cookies.length; i++) {
                                        	var cookie = jQuery.trim(cookies[i]);
                                        	// check if  cookie string begin with the name wanted
                                        	if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                                	cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                	break;
                                        	}
                                	}
                        	}
                        	return cookieValue;
                	}
  		</script>
	</head>

	<body>
		<div id="container">
              		<div id="header">
				Gladiators 
              		</div>
              		<div id="body">

				<p>
					<strong>Player: {{player.username}}</strong>&nbsp;<br>
					<input type="hidden" id="playerid" name="playerid" value="{{player.id}}"/><br>
					<p>
						You are now playing <strong>{{game.name}}</strong>
						<a href="/loadhighscores/{{game.id}}"> View high scores</a>
					</p><br>
					<iframe id="encoder_iframe" height=75% width="50%" src="{{game.url}}"></iframe>
					<br>
					<br>
					<strong>Last score: </strong>&nbsp;
                        		<span id="scores"></span><br><br>
					<strong>Game state:</strong>
                        		<div id="gamestate"></div>
					<br>
					<br>
					<a href="/playerhome/"> Go back to your homepage </a>
				</p>
				<br>
			</div>
                <div style="clear:all"></div>
		<div id="footer">
			CopyRight Â© Gladiators 2015, all rights reserved.
		</div> 
            </div>     
	</body>
</html>

